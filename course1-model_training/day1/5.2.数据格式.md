## æ•°æ®æ ¼å¼

### ä¸€ã€æ•´ä½“é€Ÿè§ˆï¼ˆå…ˆç»™ç»“è®ºï¼‰

| åç§°         | æœ¬è´¨         | æ•°æ®æ ¼å¼              | æ˜¯å¦ ranking | å…³é”®å­—æ®µ                         | ä¸»è¦ç”¨é€”         |
| ---------- | ---------- | ----------------- | ---------- | ---------------------------- | ------------ |
| **Alpaca** | æŒ‡ä»¤ç›‘ç£æ•°æ®     | alpaca            | âŒ          | instruction / input / output | SFTï¼ˆæŒ‡ä»¤å¾®è°ƒï¼‰    |
| **Glaive** | å·¥å…·è°ƒç”¨/å¤šè§’è‰²å¯¹è¯ | sharegpt          | âŒ          | conversations + tools        | Tool SFT     |
| **DPO**    | æˆå¯¹åå¥½æ•°æ®     | alpaca / sharegpt | âœ…          | chosen / rejected            | å¯¹é½ä¼˜åŒ–         |
| **KTO**    | å•å›ç­”äººç±»åé¦ˆ    | alpaca / sharegpt | âŒ          | kto_tag                      | è½»é‡å¯¹é½         |
| **MLLM**   | å¤šæ¨¡æ€æ•°æ®      | sharegpt          | âŒ / âœ…      | images / videos / audios     | å¤šæ¨¡æ€ SFT / å¯¹é½ |



### äºŒã€Alpacaï¼šæœ€åŸºç¡€ã€æœ€é€šç”¨çš„ SFT æ•°æ®

#### 1ï¸âƒ£ Alpaca æ˜¯ä»€ä¹ˆï¼Ÿ

**Alpaca = å•è½®æˆ–å¤šè½®æŒ‡ä»¤ç›‘ç£å¾®è°ƒæ ¼å¼**

* ä¸€æ¡æ ·æœ¬ = ä¸€ä¸ªã€ŒæŒ‡ä»¤ â†’ å›ç­”ã€
* å¯é€‰ `input`ã€`system`ã€`history`
* **æ¨¡å‹ç›´æ¥å­¦å›ç­”ï¼Œä¸æ¶‰åŠåå¥½**

#### 2ï¸âƒ£ Alpaca æ•°æ®é•¿ä»€ä¹ˆæ ·ï¼Ÿ

```py
{
  # å½“å‰è½®ã€Œç”¨æˆ·æƒ³è®©æ¨¡å‹åšä»€ä¹ˆã€
  # ä¼šä½œä¸º prompt çš„ä¸»è¦è¾“å…¥ä¹‹ä¸€
  # âŒ ä¸å‚ä¸ loss
  "instruction": "ç”¨æˆ·æŒ‡ä»¤",

  # ç»™ instruction è¡¥å……çš„å…·ä½“å†…å®¹ / å‚æ•°
  # å®é™… prompt ä¸­æ˜¯ï¼šinstruction + '\n' + input
  # âŒ ä¸å‚ä¸ loss
  "input": "ç”¨æˆ·è¾“å…¥ï¼ˆå¯é€‰ï¼‰",

  # æ¨¡å‹åœ¨å½“å‰è½®ã€Œåº”è¯¥è¾“å‡ºçš„æ ‡å‡†ç­”æ¡ˆã€
  # âœ… è¿™æ˜¯å”¯ä¸€ä¼šè¢«æ¨¡å‹å­¦ä¹ ã€è®¡ç®— loss çš„å†…å®¹
  "output": "æ¨¡å‹å›ç­”",

  # æ•´ä¸ªå¯¹è¯æœ€å‰é¢çš„ç³»ç»Ÿçº§çº¦æŸ / äººè®¾ / é£æ ¼
  # å½±å“å›ç­”æ–¹å¼ï¼Œä½†æœ¬èº«ä¸ä½œä¸ºå­¦ä¹ ç›®æ ‡
  # âŒ ä¸å‚ä¸ loss
  "system": "ç³»ç»Ÿæç¤ºï¼ˆå¯é€‰ï¼‰",

  # å†å²å¤šè½®å¯¹è¯
  # æ¯ä¸€å¯¹ [ç”¨æˆ·æŒ‡ä»¤, æ¨¡å‹å›ç­”] éƒ½ä¼šè¢«æ‹¼è¿› prompt
  # âš ï¸ æ³¨æ„ï¼šhistory é‡Œçš„ã€Œå›ç­”ã€ä¹Ÿä¼šè¢«å½“ä½œæ­£ç¡®ç¤ºä¾‹å­¦ä¹ 
  "history": [
    ["ä¸Šä¸€è½®æŒ‡ä»¤", "ä¸Šä¸€è½®å›ç­”"]
  ]
}
```

##### å®é™…å–‚ç»™æ¨¡å‹çš„ prompt

```
[system]
[history...]
[instruction + input]
â†’ é¢„æµ‹ output
```

#### 3ï¸âƒ£ dataset_info.json é…ç½®

```json
{
  "file_name": "data.json",
  "columns": {
    "prompt": "instruction",
    "query": "input",
    "response": "output",
    "system": "system",
    "history": "history"
  }
}
```

#### 4ï¸âƒ£ é€‚ç”¨åœºæ™¯

* æŒ‡ä»¤ç†è§£
* é—®ç­”
* æ¨ç†ï¼ˆå« CoTï¼‰
* é¢„è®­ç»ƒï¼ˆç”¨ `text` å­—æ®µï¼‰

âœ… **è¿™æ˜¯æ‰€æœ‰è®­ç»ƒçš„åœ°åŸº**



### ä¸‰ã€Glaiveï¼šå·¥å…·è°ƒç”¨ / å¤šè§’è‰²å¯¹è¯ï¼ˆShareGPTï¼‰

#### 1ï¸âƒ£ Glaive æ˜¯ä»€ä¹ˆï¼Ÿ

**Glaive æœ¬è´¨ä¸æ˜¯ä¸€ç§â€œæ–°æ ¼å¼â€ï¼Œè€Œæ˜¯ï¼š**

> ğŸ‘‰ ä½¿ç”¨ **ShareGPT æ ¼å¼** çš„
> ğŸ‘‰ **å¤šè§’è‰² / å·¥å…·è°ƒç”¨ / å‡½æ•°è°ƒç”¨ SFT æ•°æ®**

å®ƒé€šå¸¸åŒ…å«ï¼š

* human
* gpt
* function_call
* observation

#### 2ï¸âƒ£ Glaive / ShareGPT æ ·ä¾‹

```py
{
  # å¤šè½®å¯¹è¯åˆ—è¡¨ï¼ˆsharegpt / glaive æ ¼å¼çš„æ ¸å¿ƒï¼‰
  # æŒ‰é¡ºåºæ‹¼æ¥æˆå®Œæ•´ prompt
  "conversations": [
    # ç”¨æˆ·è¾“å…¥ï¼ˆäººç±»ï¼‰
    # ä½œä¸ºæ¨¡å‹çš„è¾“å…¥ä¸Šä¸‹æ–‡
    # âŒ ä¸å‚ä¸ loss
    {"from": "human", "value": "æŸ¥ä¸€ä¸‹å¤©æ°”"},

    # æ¨¡å‹â€œåº”è¯¥å­¦ä¼šè¾“å‡ºçš„å·¥å…·è°ƒç”¨æ ¼å¼â€
    # åœ¨ SFT ä¸­ï¼Œfunction_call å’Œ gpt ä¸€æ ·éƒ½ä¼šè¢«å½“ä½œæ¨¡å‹è¾“å‡ºå­¦ä¹ 
    # âœ… å‚ä¸ loss
    {"from": "function_call", "value": "{city: åŒ—äº¬}"},

    # å·¥å…·çœŸå®è¿”å›çš„ç»“æœ
    # ä½œä¸ºä¸Šä¸‹æ–‡å–‚ç»™æ¨¡å‹
    # âŒ ä¸å‚ä¸ loss
    {"from": "observation", "value": "æ™´ï¼Œ25â„ƒ"},

    # æ¨¡å‹æœ€ç»ˆç»™ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€å›å¤
    # âœ… å‚ä¸ loss
    {"from": "gpt", "value": "åŒ—äº¬ä»Šå¤©æ™´ï¼Œ25â„ƒ"}
  ],
  # å½“å‰æ ·æœ¬å¯ç”¨çš„å·¥å…· / å‡½æ•°è¯´æ˜
  # ä¼šè¢«æ‹¼è¿› system prompt æˆ–ä¸Šä¸‹æ–‡
  # âŒ ä¸å‚ä¸ loss
  "tools": "å·¥å…·æè¿°"
}
```

âš ï¸ è§’è‰²é¡ºåºè§„åˆ™å¾ˆé‡è¦ï¼š

* human / observation â†’ **å¥‡æ•°ä½**
* gpt / function â†’ **å¶æ•°ä½**

#### 3ï¸âƒ£ dataset_info.json é…ç½®

```json
{
  "file_name": "data.json",
  "formatting": "sharegpt",
  "columns": {
    "messages": "conversations",
    "tools": "tools",
    "system": "system"
  }
}
```

#### 4ï¸âƒ£ é€‚ç”¨åœºæ™¯

* Tool Calling
* Function Calling
* Agent / ReAct
* å¤šè½®å¤æ‚å¯¹è¯

âœ… **è¿™æ˜¯ Agent èƒ½åŠ›çš„æ ¸å¿ƒæ•°æ®å½¢æ€**



### å››ã€DPOï¼šåå¥½å¯¹é½ï¼ˆæˆå¯¹æ¯”è¾ƒï¼‰

#### 1ï¸âƒ£ DPO æ˜¯ä»€ä¹ˆï¼Ÿ

**DPO = Direct Preference Optimization**

* ä¸ç»™ reward
* ç›´æ¥å‘Šè¯‰æ¨¡å‹ï¼š**A æ¯” B å¥½**
* ä¸€æ¡æ ·æœ¬ = **åŒä¸€ä¸Šä¸‹æ–‡ + ä¸¤ä¸ªå›ç­”**

#### 2ï¸âƒ£ Alpaca é£æ ¼ DPO

```json
{
  "instruction": "é—®é¢˜",
  "chosen": "å¥½å›ç­”",
  "rejected": "å·®å›ç­”"
}
```

```json
{
  "ranking": true,
  "columns": {
    "prompt": "instruction",
    "chosen": "chosen",
    "rejected": "rejected"
  }
}
```

#### 3ï¸âƒ£ ShareGPT é£æ ¼ DPO

```json
{
  "conversations": [
    {"from": "human", "value": "é—®é¢˜"}
  ],
  "chosen": {"from": "gpt", "value": "å¥½å›ç­”"},
  "rejected": {"from": "gpt", "value": "å·®å›ç­”"}
}
```

```json
{
  "formatting": "sharegpt",
  "ranking": true,
  "columns": {
    "messages": "conversations",
    "chosen": "chosen",
    "rejected": "rejected"
  }
}
```

#### 4ï¸âƒ£ é€‚ç”¨åœºæ™¯

* Chat æ¨¡å‹å¯¹é½
* å‡å°‘èƒ¡ç¼– / ä¸å®‰å…¨è¾“å‡º
* SFT ä¹‹åçš„ç²¾ä¿®

âœ… **é«˜è´¨é‡ DPO æ•°æ® â‰ˆ æ¨¡å‹æ€§æ ¼å¡‘é€ **



### äº”ã€KTOï¼šè½»é‡çº§äººç±»åé¦ˆ

#### 1ï¸âƒ£ KTO æ˜¯ä»€ä¹ˆï¼Ÿ

**KTO = Kahneman-Tversky Optimization**

ä¸ DPO çš„åŒºåˆ«ï¼š

| DPO                | KTO     |
| ------------------ | ------- |
| ä¸€å¯¹å›ç­”               | å•ä¸ªå›ç­”    |
| ç›¸å¯¹åå¥½               | ç»å¯¹åé¦ˆ    |
| chosen vs rejected | ğŸ‘ / ğŸ‘ |

#### 2ï¸âƒ£ KTO æ ·ä¾‹ï¼ˆShareGPTï¼‰

```py
{
  "conversations": [
    {"from": "human", "value": "é—®é¢˜"},
    {"from": "gpt", "value": "å›ç­”"}
  ],
  # äººç±»å¯¹è¿™æ¡ã€Œæ¨¡å‹å›ç­”ã€çš„åé¦ˆæ ‡ç­¾
  # true  = å¥½å›ç­”ï¼ˆé¼“åŠ±æ¨¡å‹é è¿‘ï¼‰
  # false = åå›ç­”ï¼ˆæƒ©ç½šæ¨¡å‹è¿œç¦»ï¼‰
  # âœ… å†³å®š loss çš„æ­£è´Ÿæ–¹å‘
  "kto_tag": true
}
```

```py
{
  # æŒ‡å®šè¯¥æ•°æ®é›†ä½¿ç”¨ sharegpt æ ¼å¼è§£æ
  "formatting": "sharegpt",
  "columns": {
    "messages": "conversations",
    # å‘Šè¯‰ LLaMA-Factoryï¼š
    # å“ªä¸€åˆ—æ˜¯ KTO çš„äººç±»åé¦ˆæ ‡ç­¾
    # ç”¨æ¥å†³å®šå¥–åŠ± / æƒ©ç½šå½“å‰ gpt å›ç­”
    "kto_tag": "kto_tag"
  }
}
```

#### 3ï¸âƒ£ é€‚ç”¨åœºæ™¯

* äººç±»æ‰“æ ‡ç­¾æˆæœ¬ä½
* æ—¥å¿—å›æ”¾ + å¥½åæ ‡æ³¨
* DPO æ•°æ®ä¸è¶³æ—¶

âœ… **KTO æ˜¯â€œä¾¿å®œç‰ˆå¯¹é½â€**



### å…­ã€MLLMï¼šå¤šæ¨¡æ€ï¼ˆå›¾ / è§†é¢‘ / éŸ³é¢‘ï¼‰

#### 1ï¸âƒ£ MLLM æ˜¯ä»€ä¹ˆï¼Ÿ

**MLLM = Multi-Modal Large Language Model æ•°æ®**

ç‰¹ç‚¹ï¼š

* åŸºäº **ShareGPT**
* æ–‡æœ¬ä¸­ç”¨ `<image>` / `<video>` / `<audio>`
* æ–‡ä»¶è·¯å¾„æ”¾åœ¨ç‹¬ç«‹åˆ—

#### 2ï¸âƒ£ å›¾åƒç¤ºä¾‹

```json
{
  "conversations": [
    {"from": "human", "value": "<image>è¿™æ˜¯ä»€ä¹ˆï¼Ÿ"},
    {"from": "gpt", "value": "è¿™æ˜¯ä¸€åªçŒ«"}
  ],
  "images": ["cat.jpg"]
}
```

```json
{
  "formatting": "sharegpt",
  "columns": {
    "messages": "conversations",
    "images": "images"
  }
}
```

âš ï¸ `<image>` æ•°é‡å¿…é¡» == images æ•°é‡

#### 3ï¸âƒ£ è§†é¢‘ / éŸ³é¢‘å®Œå…¨ä¸€è‡´

| ç±»å‹ | å ä½ç¬¦       | å­—æ®µ     |
| -- | --------- | ------ |
| å›¾åƒ | `<image>` | images |
| è§†é¢‘ | `<video>` | videos |
| éŸ³é¢‘ | `<audio>` | audios |

#### 4ï¸âƒ£ é€‚ç”¨åœºæ™¯

* LLaVA / Qwen-VL
* è§†è§‰é—®ç­”
* å¤šæ¨¡æ€ Agent

### ä¸ƒã€dataset_info.json

#### 1ï¸âƒ£ å…³äº formatting
##### LLaMA-Factory çš„é»˜è®¤è¡Œä¸º

åœ¨ `dataset_info.json` é‡Œï¼š

* **é»˜è®¤æ ¼å¼ = `alpaca`**
* åªæœ‰å½“ä½ ç”¨ **sharegpt / openai / mllm** è¿™ç§ç»“æ„æ—¶
  ğŸ‘‰ æ‰éœ€è¦æ˜¾å¼å†™ï¼š

```json
"formatting": "sharegpt"
```

##### å¿«é€Ÿåˆ¤æ–­è§„åˆ™ï¼ˆè®°è¿™ä¸ªå°±å¤Ÿï¼‰

> **åªè¦æ•°æ®é‡Œæœ‰ `conversations` / `messages`ï¼Œå°±å¿…é¡»å†™ `formatting: sharegpt`**



#### 2ï¸âƒ£  `columns` é‡Œåˆ°åº•èƒ½å†™ä»€ä¹ˆæ˜ å°„ï¼Ÿ


##### columns æ˜¯å¹²å˜›çš„ï¼Ÿ

ä¸€å¥è¯ï¼šæŠŠâ€œä½ çš„å­—æ®µåâ€æ˜ å°„æˆ LLaMA-Factory è®¤è¯†çš„â€œè¯­ä¹‰å­—æ®µâ€

æ ¼å¼æ°¸è¿œæ˜¯ï¼š

```json
"columns": {
  "è¯­ä¹‰å­—æ®µ": "ä½ æ–‡ä»¶é‡Œçš„å­—æ®µå"
}
```

##### æ‰€æœ‰ã€Œåˆæ³•çš„è¯­ä¹‰å­—æ®µã€ä¸€è§ˆï¼ˆé‡ç‚¹ï¼‰

>ğŸ”¹ Alpaca / é€šç”¨å­—æ®µ

| è¯­ä¹‰å­—æ®µ       | å«ä¹‰          |
| ---------- | ----------- |
| `prompt`   | ä¸»æŒ‡ä»¤         |
| `query`    | æŒ‡ä»¤è¡¥å……ï¼ˆinputï¼‰ |
| `response` | æ¨¡å‹å›ç­”        |
| `system`   | ç³»ç»Ÿæç¤º        |
| `history`  | å¤šè½®å†å²        |
| `text`     | é¢„è®­ç»ƒçº¯æ–‡æœ¬      |

>ğŸ”¹ ShareGPT ä¸“ç”¨

| è¯­ä¹‰å­—æ®µ       | å«ä¹‰                             |
| ---------- | ------------------------------ |
| `messages` | å¯¹è¯åˆ—è¡¨ï¼ˆconversations / messagesï¼‰ |
| `tools`    | å·¥å…·æè¿°                           |
| `system`   | ç³»ç»Ÿæç¤º                           |

>åå¥½ / å¯¹é½ï¼ˆDPO / ORPO / SimPOï¼‰

| è¯­ä¹‰å­—æ®µ       | ç”¨é€”                     |
| ---------- | ---------------------- |
| `chosen`   | æ›´å¥½çš„å›ç­”                  |
| `rejected` | æ›´å·®çš„å›ç­”                  |
| `ranking`  | æ˜¯å¦åå¥½æ•°æ®ï¼ˆé…ç½®é¡¹ï¼Œä¸åœ¨ columnsï¼‰ |

>ğŸ”¹ KTO

| è¯­ä¹‰å­—æ®µ      | ç”¨é€”         |
| --------- | ---------- |
| `kto_tag` | äººç±»åé¦ˆï¼ˆboolï¼‰ |

>ğŸ”¹ å¤šæ¨¡æ€ï¼ˆMLLMï¼‰

| è¯­ä¹‰å­—æ®µ     | å«ä¹‰   |
| -------- | ---- |
| `images` | å›¾ç‰‡è·¯å¾„ |
| `videos` | è§†é¢‘è·¯å¾„ |
| `audios` | éŸ³é¢‘è·¯å¾„ |


#### 3ï¸âƒ£ ä¸€ä¸ªâ€œä¸‡èƒ½åˆ¤æ–­è¡¨â€

| æ•°æ®é‡Œæœ‰ä»€ä¹ˆ               | formatting        | columns è‡³å°‘è¦æœ‰       |
| -------------------- | ----------------- | ------------------ |
| instruction / output | alpacaï¼ˆé»˜è®¤ï¼‰        | prompt + response  |
| conversations        | sharegpt          | messages           |
| chosen / rejected    | alpaca æˆ– sharegpt | chosen + rejected  |
| kto_tag              | sharegpt          | messages + kto_tag |
| images / video       | sharegpt          | messages + images  |




### å…«ã€æ€»ç»“

> **LLaMA-Factory åªå…³å¿ƒä¸‰ä»¶äº‹ï¼š**

1. **æ˜¯ä¸æ˜¯ alpaca è¿˜æ˜¯ sharegpt**
2. **æ˜¯ä¸æ˜¯ rankingï¼ˆåå¥½ï¼‰**
3. **æœ‰æ²¡æœ‰å¤šæ¨¡æ€å­—æ®µ**

ä¸€åˆ‡è®­ç»ƒæ–¹å¼ï¼ˆSFT / DPO / KTO / MLLMï¼‰
ğŸ‘‰ éƒ½æ˜¯è¿™ä¸‰ç‚¹çš„ä¸åŒç»„åˆã€‚

